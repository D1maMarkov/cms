{% extends "user/base.html" %}
{% load static %}

{% block title %}
    Сброс пароль
{% endblock %}

{% block content %}

<form onsubmit="getForm(event)" method="post" class="user-form" style="height: 200px;">
    <h3>Сбросить пароль</h3>

    {% csrf_token %}
    {% for field in form %}
        <div class="field" id="{{ field.name }}">
            {{ field }}
            <div class="error"></div>
            {% for error in field.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
    {% endfor %}

    <a class="message"></a>
    <input disabled type="submit" value="Сбросить пароль" />
</form>

<script src="{% static "user/js/token.js" %}"></script>
<script src="{% static 'user/js/set_password.js' %}"></script>


<style>
    .user-form input{
        width: 100%;
    }

    .user-form span{
        font-size: 12px;
        font-weight: 400;
        margin-top: 15px;
    }
</style>

{% endblock %}



{% block additional_scripts %}
<script src="{% static "user/js/reset_password_form.js" %}"></script>

<script>
    function getForm(event){
        event.preventDefault();
        const form = document.querySelector(".user-form")
        const data = new FormData(form);

        fetch("/user/reset-password", {
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: JSON.stringify({
                "csrfmiddlewaretoken": data.get("csrfmiddlewaretoken"),
                "email": data.get("email")
            })
        }).then(response => {
            if (response.status === 200){
                response.json().then((response) => {
                    document.querySelector(".message").innerHTML = response.message;
                })
            }
            return response.json();
        }).then(response => {
            const errors = response.errors;
            setError("email", "")
            console.log(errors);
            for (let field of Object.keys(errors)) {
                console.log(field, errors[field]);
                setError(field, errors[field][0]);
            }
        })
    }
</script>
{% endblock %}
